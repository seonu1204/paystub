<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>사용자 페이지</title>
    <style>

        /* 메인테이블 스타일 */
        table {
            border-collapse: collapse;
            width: 100%;
        }

        /* 지급금액, 공제금액 테이블 스타일 */
        .table2 {
            border-collapse: collapse;
            width: 80%;
        }

        /* 숨겨야할 셀 스타일 */
        .hide {
            border: 1px white;
        }

        /* 테이블 안 th, td 스타일 */
        th,
        td {
            border: 1px solid black;
            padding: 5px 5px;
            text-align: center;
            border-width: 2px;
            width: 200px;
            height: 1px;
        }

        /* 중앙 정렬 */
        .center {
            text-align: center;
        }

        .right {
            text-align: right;
        }

        /* 텍스트 여백을 두어 테이블 간 거리 간격 조정 */
        .textMargin {
            margin-top: 50px;
        }

        /* 메인 테이블 여백을 두어 거리 간격 조절 */
        .tableMargin {
            margin-top: 50px;
        }


        /* 각 테이블의 첫번째 Tr에만 해당하는 스타일 */
        .firstTr {
            background-color: rgb(192, 192, 192);
            font-weight: 1000;
        }

        /* 화면 여백 */
        .padding {
            padding: 40px 40px 40px 40px;
        }
    </style>
</head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
<script type="text/javascript" src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<body th:each="totalData : ${totalData}">



<div id = "start" class="report" >
    <div class="padding">
    <div class="center">
        <h2>일용근로자 급여 지급명세서 (<span id="year" th:text="${totalData.year}"></span>년 <span id="month" th:text="${totalData.month}"></span>월 귀속)</h2>
        <h5>회사명: 나이스디앤알(주)</h5>
        <h5>사번: <span id="employeeID"th:text="${totalData.employeeID}"></span>          성명: <span id="name" th:text="${totalData.name}"></span></h5>
        <h5>생년월일: <span th:text="${totalData.birthday}"></span>        지급일: <span></span></h5>
    </div>

    <!-- 메인 테이블 -->
    <table id="mainTable" class="tableMargin">
        <tr class="firstTr">
            <td>지급</td>
            <td></td>
            <td>공제</td>
            <td></td>
            <td>근태</td>
            <td></td>
        </tr>
        <tr>
            <td>항목</td>
            <td>금액</td>
            <td>항목</td>
            <td>금액</td>
            <td>항목</td>
            <td>내용</td>
        </tr>
        <tr>
            <td>기본수당</td>
            <td th:text="${#numbers.formatInteger(totalData.basicSalary, 3, 'COMMA')}" class="right"></td>
            <td>소득세</td>
            <td th:text="${#numbers.formatInteger(totalData.incomeTax, 3, 'COMMA')}" class="right"></td>
            <td>총근로일수</td>
            <td th:text="${totalData.totalWorkDays}" class="right"></td>
        </tr>
        <tr>
            <td>주휴수당</td>
            <td th:text="${#numbers.formatInteger(totalData.holidayAllowance, 3, 'COMMA')}" class="right"></td>
            <td>주민세</td>
            <td th:text="${#numbers.formatInteger(totalData.residentTax, 3, 'COMMA')}" class="right"></td>
            <td>총근무시간</td>
            <td th:text="${totalData.totalWorkingHours}" class="right"></td>
        </tr>
        <tr>
            <td>중식비</td>
            <td th:text="${#numbers.formatInteger(totalData.lunchExpenses, 3, 'COMMA')}" class="right"></td>
            <td>고용보험</td>
            <td th:text="${#numbers.formatInteger(totalData.employmentInsurance, 3, 'COMMA')}" class="right"></td>
            <td>주휴산정시간</td>
            <td th:text="${totalData.holidayCalculationHours}" class="right"></td>
        </tr>
        <tr>
            <td>주휴수당(첫째주)</td>
            <td th:text="${#numbers.formatInteger(totalData.firstWeekHolidayAllowance, 3, 'COMMA')}" class="right"></td>
            <td>국민연금</td>
            <td th:text="${#numbers.formatInteger(totalData.nationalPension, 3, 'COMMA')}" class="right"></td>
            <td>주휴산정시간(소급)</td>
            <td th:text="${totalData.overtimeCalculationHours}" class="right"></td>
        </tr>
        <tr>
            <td>주휴수당(소급분)</td>
            <td th:text="${#numbers.formatInteger(totalData.retroactiveHolidayAllowance, 3, 'COMMA')}" class="right"></td>
            <td>건강보험</td>
            <td th:text="${#numbers.formatInteger(totalData.healthInsurance, 3, 'COMMA')}" class="right"></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td>노인요양</td>
            <td th:text="${#numbers.formatInteger(totalData.elderlyCareInsurance, 3, 'COMMA')}" class="right"></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td>고용보험(소급공제)</td>
            <td th:text="${#numbers.formatInteger(totalData.employmentInsuranceDeduction, 3, 'COMMA')}" class="right"></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td>국민연금(소급공제)</td>
            <td th:text="${#numbers.formatInteger(totalData.nationalPensionDeduction, 3, 'COMMA')}" class="right"></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td>건강보험(소급공제)</td>
            <td th:text="${#numbers.formatInteger(totalData.healthInsuranceDeduction, 3, 'COMMA')}" class="right"></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td>노인요양(소급공제)</td>
            <td th:text="${#numbers.formatInteger(totalData.elderlyCareInsuranceDeduction, 3, 'COMMA')}" class="right"></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>지급합계</td>
            <td th:text="${#numbers.formatInteger(totalData.totalPayment, 3, 'COMMA')}" class="right"></td>
            <td>공제합계</td>
            <td th:text="${#numbers.formatInteger(totalData.deductionTotal, 3, 'COMMA')}" class="right"></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <!-- 보이지 않게 되어있는 td는 hide 클래스 처리 -->
            <td class="hide"></td>
            <td class="hide" ></td>
            <td>실 지급액</td>
            <td th:text="${#numbers.formatInteger(totalData.netPayment, 3, 'COMMA')}" class="right"></td>
            <td class="hide"></td>
            <td class="hide"></td>
        </tr>
    </table>

    <!-- 지급금액 산출내역 테이블 -->
    <h3 class="textMargin">[지급금액 산출내역]</h3>
    <table id="payment" margin-align="left" class="table2">
        <tr class="firstTr">
            <td>지급내역</td>
            <td colspan="6">산출내역</td>
            <td>금액</td>
        </tr>
        <tr>
            <td>기본수당</td>
            <td colspan="6"><span th:text="${totalData.hourlyWage}"></span> 원 * 근로시간</td>
            <td th:text="${#numbers.formatInteger(totalData.basicSalary, 3, 'COMMA')}" class="right"></td>
        </tr>
        <tr>
            <td>주휴수당</td>
            <td colspan="6"><span th:text="${totalData.hourlyWage}"></span> 원 * 주휴시간</td>
            <td th:text="${#numbers.formatInteger(totalData.holidayAllowance, 3, 'COMMA')}" class="right"></td>
        </tr>
        <tr>
            <td>중식비</td>
            <td colspan="6">       원 * 근무일수</td>
            <td th:text="${#numbers.formatInteger(totalData.lunchExpenses, 3, 'COMMA')}" class="right"></td>
        </tr>
        <tr>
            <td>주휴수당(첫째주)</td>
            <td colspan="6"><span th:text="${totalData.hourlyWage}"></span> 원 * 주휴시간</td>
            <td th:text="${#numbers.formatInteger(totalData.firstWeekHolidayAllowance, 3, 'COMMA')}" class="right"></td>
        </tr>
        <tr>
            <td>주휴수당(소급분)</td>
            <td colspan="6"><span th:text="${totalData.hourlyWage}"></span> 원 * 주휴시간</td>
            <td th:text="${#numbers.formatInteger(totalData.retroactiveHolidayAllowance, 3, 'COMMA')}" class="right"></td>
        </tr>
    </table>
    <!-- 공제금액 산출내역 -->
    <h3 class="textMargin">[공제금액 산출내역]</h3>
    <table id="deduction" class="table2">
        <tr class="firstTr">
            <td>공제내역</td>
            <td colspan="2">산출내역</td>
            <td>금액</td>
        </tr>
        <tr>
            <td>소득세</td>
            <td colspan="2">간이세액표 참조</td>
            <td th:text="${#numbers.formatInteger(totalData.incomeTax, 3, 'COMMA')}" class="right"></td>
        </tr>
        <tr>
            <td>주민세</td>
            <td colspan="2">소득세 * 0.1000</td>
            <td th:text="${#numbers.formatInteger(totalData.residentTax, 3, 'COMMA')}" class="right"></td>
        </tr>
        <tr>
            <td>고용보험</td>
            <td colspan="2">과세총액 * 0.0090</td>
            <td th:text="${#numbers.formatInteger(totalData.employmentInsurance, 3, 'COMMA')}" class="right"></td>
        </tr>
        <tr>
            <td>국민연금</td>
            <td colspan="2">과세총액 * 0.0450</td>
            <td th:text="${#numbers.formatInteger(totalData.nationalPension, 3, 'COMMA')}" class="right"></td>
        </tr>
        <tr>
            <td>건강보험</td>
            <td colspan="2">과세총액 * 0.03545</td>
            <td th:text="${#numbers.formatInteger(totalData.healthInsurance, 3, 'COMMA')}" class="right"></td>
        </tr>
        <tr>
            <td>노인요양보험</td>
            <td colspan="2">건강보험 * 0.1281</td>
            <td th:text="${#numbers.formatInteger(totalData.elderlyCareInsurance, 3, 'COMMA')}" class="right"></td>
        </tr>
    </table>
    <div id="end" class="report"></div>

</div>

</div>


<button type="button" id="pdf">pdf 다운</button>


<script type="text/javascript">
    let all_area_array = ['#start','#end']; //전체영역 area
    let area_array = ['#start']; //pdf 다운 영역

    $('#pdf').on("click", function () {
        let difference = all_area_array.filter(x => !area_array.includes(x));

        $.each(difference,function(index, item){
            $(item).attr('data-html2canvas-ignore', true);
        });
        setTimeout(pdfMake(),500);
    });

    const pdfMake = () => {
        html2canvas($('.report')[0]).then(function(canvas) {
            let imgData = canvas.toDataURL('image/png');

            let imgWidth = 210; // 이미지 가로 길이(mm) A4 기준
            let pageHeight = imgWidth * 1.414;  // 출력 페이지 세로 길이 계산 A4 기준
            let imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;

            let doc = new jsPDF('p', 'mm');
            let position = 0;

            // 첫 페이지 출력
            doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            const year = document.getElementById('year').textContent;
            const month = document.getElementById('month').textContent;
            const employeeID = document.getElementById('employeeID').textContent;
            const name = document.getElementById('name').textContent;

            // 파일 저장
            doc.save(year + '년_' + month + '월_' + employeeID + '_' + name + '_급여명세서.pdf');

        });
    }
</script>

</body>
</html>